<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed - DiveConnect</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/pages/feed.html" class="navbar-logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>DiveConnect</span>
            </a>

            <ul class="navbar-menu">
                <li><a href="/pages/feed.html">Feed</a></li>
                <li><a href="/pages/perfil.html">Mi Perfil</a></li>
                <li class="navbar-user">
                    <span id="currentUsername"></span>
                    <button class="btn btn-sm btn-secondary" onclick="logout()">Salir</button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container">
        <h1 class="text-center mb-4">Mi Feed</h1>

        <!-- Formulario Nueva Publicaci贸n -->
        <div class="card">
            <form id="nuevaPublicacionForm">
                <div class="form-group">
                    <textarea class="form-input" id="contenido" placeholder="驴Qu茅 tal tu 煤ltima inmersi贸n? Comparte tu experiencia..." rows="3" required></textarea>
                </div>

                <button type="button" class="btn btn-secondary btn-sm mb-2" onclick="toggleDetalles()">
                     A帽adir detalles de inmersi贸n
                </button>

                <div id="detallesInmersion" class="hidden">
                    <div class="form-group">
                        <label class="form-label">Lugar de inmersi贸n</label>
                        <input type="text" class="form-input" id="lugarInmersion" placeholder="Ej: Islas Medas">
                    </div>

                    <div class="flex gap-2">
                        <div class="form-group">
                            <label class="form-label">Profundidad (m)</label>
                            <input type="number" step="0.1" class="form-input" id="profundidadMaxima">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Temperatura (掳C)</label>
                            <input type="number" step="0.1" class="form-input" id="temperaturaAgua">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Visibilidad (m)</label>
                            <input type="number" step="0.1" class="form-input" id="visibilidad">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Especies vistas</label>
                        <input type="text" class="form-input" id="especiesVistas" placeholder="Ej: Meros, pulpos, barracudas">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Publicar</button>
            </form>
        </div>

        <!-- Lista de Publicaciones -->
        <div id="publicacionesContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/publicaciones.js"></script>
    <script>
        requireAuth();

        // Mostrar usuario actual
        const user = getCurrentUser();
        document.getElementById('currentUsername').textContent = user.username;

        // Toggle detalles de inmersi贸n
        function toggleDetalles() {
            document.getElementById('detallesInmersion').classList.toggle('hidden');
        }

        // Cargar feed
        async function loadFeed() {
            try {
                const publicaciones = await getFeed();
                const container = document.getElementById('publicacionesContainer');
                
                if (publicaciones.length === 0) {
                    container.innerHTML = '<div class="card text-center">No hay publicaciones a煤n. 隆S茅 el primero en compartir!</div>';
                } else {
                    container.innerHTML = publicaciones.map(p => renderPublicacion(p)).join('');
                }
            } catch (error) {
                showAlert('Error al cargar publicaciones', 'error');
            }
        }

        // Form submit
        document.getElementById('nuevaPublicacionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                contenido: document.getElementById('contenido').value,
                lugarInmersion: document.getElementById('lugarInmersion').value || null,
                profundidadMaxima: document.getElementById('profundidadMaxima').value ? parseFloat(document.getElementById('profundidadMaxima').value) : null,
                temperaturaAgua: document.getElementById('temperaturaAgua').value ? parseFloat(document.getElementById('temperaturaAgua').value) : null,
                visibilidad: document.getElementById('visibilidad').value ? parseFloat(document.getElementById('visibilidad').value) : null,
                especiesVistas: document.getElementById('especiesVistas').value || null,
            };
            
            try {
                await createPublicacion(data);
                showAlert('隆Publicaci贸n creada!', 'success');
                
                // Limpiar form
                document.getElementById('nuevaPublicacionForm').reset();
                document.getElementById('detallesInmersion').classList.add('hidden');
                
                // Recargar feed
                loadFeed();
            } catch (error) {
                showAlert('Error al crear publicaci贸n', 'error');
            }
        });

        // Cargar feed al inicio
        loadFeed();
    </script>
</body>
</html>